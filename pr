#!/usr/bin/env bash

#
# List Pull-Requests of an Azure Project
#
# USAGE
#
#     pr                                       # list completed pull requests
#     pr TYPE                                  # list pull requests of TYPE: active, all, completed, abandoned [default: all]
#     pr -n COUNT                              # set number of pull requests returned [default: 100]
#     pr -s DIRECTION                          # set sort direction by date 'asc' | 'desc' [default: desc]
#     pr --csv                                 # list pull requests as CSV
#
# EXAMPLES
#
#     pr --csv -s asc | vd
#     pr | grep 1234
#     pr | rg 1234
#     pr completed | rg -f <(cat pattern-list.txt)
#

show_help() {
  awk '/^[^ #]/{c=1}c==0{print $0}' $0 | sed -n '/^#/p' | sed 1d | sed 's/^#/ /g' \
    | perl -pe "s/ #(.*)$/$(tput setaf 0)\1$(tput sgr 0)/" \
    | perl -pe "s/(USAGE|EXAMPLES|COMMANDS)/$(tput setaf 0)\1$(tput sgr 0)/" \
    | perl -pe "s/\`(.+)\`/$(tput sgr 0 1)\1$(tput sgr 0)/"
  exit 1
}

help_envs() {
  echo -e >&2 "\n environment variable $(tput setaf 1)${1}$(tput sgr0) is not set."
  echo -e "\n export variables based on this URL:\n $(tput setaf 0)https://dev.azure.com/$(tput setaf 8)<organization>$(tput setaf 0)/$(tput setaf 8)<project>$(tput setaf 0)/_git/$(tput setaf 8)<repository>$(tput sgr0)"
  echo -e "\n    $(tput setaf 0)export AZDO_ORGANIZATION=\"$(tput setaf 8)<organization>$(tput setaf 0)\"$(tput sgr0)"
  echo -e "    $(tput setaf 0)export AZDO_PROJECT=\"$(tput setaf 8)<project>$(tput setaf 0)\"$(tput sgr0)"
  echo -e "    $(tput setaf 0)export AZDO_REPOSITORY=\"$(tput setaf 8)<repository>$(tput setaf 0)\"$(tput sgr0)"
  echo -e "    $(tput setaf 0)export AZDO_REVIEWER=\"$(tput setaf 8)<your-email>$(tput setaf 0)\"$(tput sgr0)"
  exit 1
}
[ -z "$AZDO_ORGANIZATION" ] && help_envs "AZDO_ORGANIZATION"
[ -z "$AZDO_PROJECT" ] && help_envs "AZDO_PROJECT"
[ -z "$AZDO_REPOSITORY" ] && help_envs "AZDO_REPOSITORY"
[ -z "$AZDO_REVIEWER" ] && help_envs "AZDO_REVIEWER"

csv=false
size=100
pr_status="all"
sort_direction="desc"
AZDO_URL="dev.azure.com/${AZDO_ORGANIZATION}/${AZDO_PROJECT/ /%20}/_git/${AZDO_REPOSITORY}/pullrequest"

while [ $# -gt 0 ]; do
  case $1 in
    --csv)
      csv=true
      ;;
    -n)
      shift
      size=$1
      ;;
    -s)
      shift
      sort_direction=$1
      ;;
    -h|--help)
      show_help
      ;;
    *)
      pr_status=$1
      ;;
  esac
  shift
done


[[ $pr_status == "completed" ]] && sort_by="completionQueueTime" || sort_by="creationDate"
[[ $sort_direction == "desc" ]] && sort_dir="reverse" || sort_dir=""

if [[ $csv == true ]]; then
  (echo "Creation Date,Completion Date,Pull Request ID,Branch,Title";
   az repos pr list --org "https://dev.azure.com/${AZDO_ORGANIZATION}" \
     -p "${AZDO_PROJECT}" \
     -r "${AZDO_REPOSITORY}" \
     --status "${pr_status}" \
     --top "$size" \
     --query "${sort_dir}(sort_by([], &${sort_by}))[*].{Title: title, PR: pullRequestId, Creation: creationDate, Completion: completionQueueTime, Branch: sourceRefName}" \
     -o 'json' \
     | jq -r '.[] | "\(.Creation[:10]),\(.Completion[:10]//""),\(.PR),\(.Branch|sub("refs/heads/";"")),\"\(.Title)\""' )
else
  echo -e >&2 "\n $(tput setaf 0)[${size} PRs]$(tput sgr0) $(tput setaf 2)${pr_status^}$(tput sgr0) Pull-Requests of Project $(tput setaf 2)$AZDO_PROJECT$(tput sgr0):\n"
  [[ $DEBUG == "1" ]] && echo -e "$(tput setaf 0)az repos pr list --org \"https://dev.azure.com/${AZDO_ORGANIZATION}\" -p \"${AZDO_PROJECT}\" -r \"${AZDO_REPOSITORY}\" --status \"${pr_status}\" --top ${size} --query \"reverse(sort_by([], &${sort_by}))[*].{Title: title, PR: pullRequestId, Creation: creationDate, Completion: completionQueueTime, Branch: sourceRefName}\" -o 'json'$(tput sgr0)\n"
  tput rmam
  az repos pr list --org "https://dev.azure.com/${AZDO_ORGANIZATION}" \
     -p "${AZDO_PROJECT}" \
     -r "${AZDO_REPOSITORY}" \
     --status "${pr_status}" \
     --top "$size" \
     --query "${sort_dir}(sort_by([], &${sort_by}))[*].{Title: title, PR: pullRequestId, Creation: creationDate, Completion: completionQueueTime, Branch: sourceRefName}" \
     -o 'json' \
     | jq --arg url "https://${AZDO_URL}/" \
          -r 'def grey: "\u001b[90m";
              def reset: "\u001b[0m";
              def az_url(id): "\u001b]8;;\($url+(id|tostring))\u001b\\\(id)\u001b]8;;\u001b\\";
              .[] |
                "\(grey)\(.Creation[:10])\t\(.Completion[:10]//"")\(reset)\t\(az_url(.PR))\t\(.Branch|sub("refs/heads/";""))\t\(.Title)"
             ' \
  | column -t -s $'\t'
  tput smam
fi

